<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BeKind: Stop Bullying</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Universal box-sizing for consistent layout */
        * {
            box-sizing: border-box;
        }
        /* Body styling for font, background, and transitions */
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: #f4f8fd;
            overflow: hidden; /* Prevent body scroll, sections handle it */
            position: relative;
            transition: background 0.3s, color 0.3s;
        }
        /* Dark mode styling for body */
        body.dark-mode {
            background: #181818;
            color: #f4f4f4;
        }
        /* Header styling */
        header {
            background-color: #6a5acd;
            color: white;
            padding: 1em;
            text-align: center;
            position: relative;
        }
        /* Points display in header */
        .points {
            position: absolute;
            top: 1em;
            right: 1em;
            background: white;
            color: #6a5acd;
            padding: 0.4em 1em;
            border-radius: 20px;
            font-weight: bold;
        }
        /* Dark mode for points display */
        .dark-mode .points {
            background: #333;
            color: white;
        }
        /* Dark mode toggle button styling */
        #darkToggle {
            position: absolute;
            top: 1em;
            left: 1em;
            background: white;
            border-radius: 50%;
            padding: 0.4em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* Consistent size */
            height: 40px;
        }
        /* Navigation bar styling (fixed at bottom) */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background-color: #ffffff;
            border-top: 1px solid #ccc;
            height: 60px; /* Fixed height for nav bar */
            padding: 0; /* Remove padding from nav, add to nav a */
            z-index: 10;
        }
        /* Dark mode for navigation bar */
        .dark-mode nav {
            background-color: #222;
            border-color: #444;
        }
        nav a {
            font-size: 1.0em;
            text-decoration: none;
            color: #6a5acd; /* Default icon color */
            display: flex; /* Use flexbox for vertical centering */
            align-items: center;
            justify-content: center;
            height: 100%; /* Take full height of parent nav */
            padding: 0 0.8em; /* Only horizontal padding */
            border-radius: 8px;
            transition: background 0.2s, color: 0.2s;
        }
        /* Styling for active navigation link */
        nav a.active-nav {
            color: white; /* Active icon color */
            background-color: #6a5acd; /* Active icon background */
        }
        /* Dark mode for navigation links */
        .dark-mode nav a {
            color: #9370DB; /* Dark mode default icon color */
        }
        /* Dark mode for active navigation link */
        .dark-mode nav a.active-nav {
            color: white;
            background-color: #9370DB; /* Dark mode active background */
        }
        /* Section styling (hidden by default, shown when active) */
        section {
            display: none;
            /* Adjusted height to account for header (approx 80px) and fixed nav (60px) */
            height: calc(100vh - 140px); /* 80px (header) + 60px (nav) */
            overflow-y: auto; /* Enable scrolling for content within section */
            padding: 2em 1em 1em; /* Reduced general bottom padding */
            animation: fadeIn 1s ease-in; /* Fade-in animation */
        }
        /* Active section display */
        section.active {
            display: block;
        }
        /* Specific padding for chat section to account for chat input */
        section#chat.active {
            /* Add extra padding at the bottom to ensure content clears the chat input box */
            padding-bottom: 70px; /* Height of chat-input (60px) + a little extra margin */
        }
        /* Card styling for content containers */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5em;
            max-width: 800px;
            margin: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1em; /* Space between cards */
            /* Removed max-height and overflow-y from .card itself.
               The parent section will now handle the scrolling. */
        }
        /* Dark mode for cards */
        .dark-mode .card {
            background: #2c2c2c;
            color: white;
        }
        /* Styling for input fields, text areas, and buttons */
        input, textarea, button {
            display: block;
            width: 100%;
            padding: 1em;
            margin-top: 1em;
            border: 1px solid #bbb;
            border-radius: 8px;
            font-family: 'Segoe UI', sans-serif; /* Consistent font */
        }
        /* Dark mode for inputs and text areas */
        .dark-mode input, .dark-mode textarea {
            background: #444;
            color: white;
            border-color: #666;
        }
        /* Button specific styling */
        button {
            background-color: #6a5acd;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        /* Button hover effect */
        button:hover {
            background-color: #5a4ac0;
        }
        /* Fade-in animation definition */
        .fade {
            animation: fadeIn 1s ease-in;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(20px);}
            to {opacity: 1; transform: translateY(0);}
        }
        /* Footer styling */
        footer {
            background-color: #eee;
            text-align: center;
            padding: 1em;
            font-size: 0.9em;
            margin-bottom: 60px; /* Space for the fixed nav */
            color: #555;
        }
        /* Dark mode for footer */
        .dark-mode footer {
            background-color: #222;
            color: #bbb;
        }
        /* Chat area styling */
        #chatArea {
            height: 300px;
            overflow-y: scroll;
            padding: 1em;
            background: #f0f0f0;
            border-radius: 10px;
            margin-top: 1em; /* Adjusted for disclaimer */
            display: flex;
            flex-direction: column; /* To make messages stack */
        }
        /* Dark mode for chat area */
        .dark-mode #chatArea {
            background: #333;
        }
        /* Base styling for all chat messages */
        .chat-message {
            padding: 0.5em 1em;
            border-radius: 8px;
            margin-bottom: 0.5em;
            max-width: 80%;
            word-wrap: break-word; /* Ensure long words break */
        }
        /* Styling for user's chat messages */
        .chat-message.user {
            background: #e0e0e0;
            align-self: flex-end; /* Aligns to the right */
            text-align: right;
            color: #333;
        }
        /* Dark mode for user's chat messages */
        .dark-mode .chat-message.user {
            background: #555;
            color: white;
        }
        /* Styling for bot's chat messages */
        .chat-message.bot {
            background: #d3e0f2;
            align-self: flex-start; /* Aligns to the left */
            text-align: left;
            color: #333;
        }
        /* Dark mode for bot's chat messages */
        .dark-mode .chat-message.bot {
            background: #7a8ebc;
            color: white;
        }
        /* Chat input container styling (fixed at bottom above nav) */
        .chat-input {
            display: flex;
            gap: 0.5em;
            position: fixed;
            bottom: 60px; /* Position directly above the 60px tall nav bar */
            left: 0;
            right: 0;
            background: white;
            padding: 5px 1em; /* Adjusted padding for a total height of approx 60px */
            height: 60px; /* Fixed height for the chat input container */
            border-top: 1px solid #ccc;
            display: none; /* New: Hide by default */
            z-index: 9; /* Ensure it's below nav if they ever overlap, though they shouldn't */
        }
        /* Dark mode for chat input container */
        .dark-mode .chat-input {
            background: #222;
            border-color: #444;
        }
        /* Chat input textarea styling */
        .chat-input textarea {
            flex: 1;
            resize: none;
            height: 100%; /* Take full height of parent .chat-input */
            margin-top: 0; /* Override default margin */
            padding: 8px; /* Adjust padding for text area */
        }
        /* Chat input button styling */
        .chat-input button {
            width: 80px;
            margin-top: 0; /* Override default margin */
            height: 100%; /* Take full height of parent .chat-input */
            padding: 8px; /* Adjust padding for button */
        }
        /* Map styling */
        #map {
            height: 250px; /* Adjusted height to be more flexible */
            width: 100%;
            border-radius: 10px;
            margin-top: 1em;
        }
        /* Video container styling */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 10px;
            margin-top: 1em;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        /* New Quiz CSS */
        #score-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            background-color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 1em; /* Added margin for spacing */
            text-align: center;
        }
        .dark-mode #score-display {
            background-color: #444;
            color: white;
        }

        .quiz-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            text-align: center;
            margin: auto; /* Center the container */
        }

        .dark-mode .quiz-container {
             background-color: #2c2c2c;
        }

        #quizCard h1 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .dark-mode #quizCard h1 {
            color: white;
        }


        #question {
            font-size: 1.4em;
            margin-bottom: 25px;
            color: #555;
            min-height: 60px; /* To prevent layout shift for short questions */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark-mode #question {
            color: #ccc;
        }

        #options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .option {
            background-color: #e0e0e0;
            color: #333;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: left;
        }
        .dark-mode .option {
            background-color: #555;
            color: white;
        }


        .option:hover:not(.correct):not(.incorrect) {
            background-color: #d0d0d0;
            transform: translateY(-2px);
        }
        .dark-mode .option:hover:not(.correct):not(.incorrect) {
            background-color: #666;
        }


        .option.correct {
            background-color: #4CAF50; /* Green for correct */
            color: white;
            font-weight: bold;
        }

        .option.incorrect {
            background-color: #f44336; /* Red for incorrect (optional) */
            color: white;
            font-weight: bold;
        }

        .option:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        #next-btn {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #next-btn:hover {
            background-color: #0056b3;
        }

        #next-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .quiz-container {
                padding: 20px;
            }

            #quizCard h1 {
                font-size: 1.5em;
            }

            #question {
                font-size: 1.2em;
            }

            .option {
                font-size: 1em;
                padding: 12px 15px;
            }

            #next-btn {
                padding: 10px 20px;
                font-size: 1em;
            }

            #score-display {
                font-size: 1em;
                padding: 8px 12px;
                margin-top: 15px; /* Adjust top positioning for mobile */
                margin-right: 15px; /* Adjust right positioning for mobile */
            }
        }
    </style>
</head>
<body>

    <audio id="sirenSound" src="https://www.soundjay.com/misc/sounds/siren-police-01.mp3" preload="auto"></audio>

    <header>
        <div id="darkToggle" onclick="toggleDarkMode()">üåô</div>
        <div class="points">Points: <span id="points">0</span></div>
        <h1>ü§ù BeKind</h1>
        <p>üí¨ Speak up. üíó Support. üõë Stop bullying.</p>
    </header>

    <nav>
        <a href="#" onclick="showPage('home')" aria-label="Home"><i class="fas fa-home"></i></a>
        <a href="#" onclick="showPage('learn')" aria-label="Learn"><i class="fas fa-book-open"></i></a>
        <a href="#" onclick="showPage('chat')" aria-label="Chat"><i class="fas fa-comments"></i></a>
        <a href="#" onclick="showPage('report')" aria-label="Report"><i class="fas fa-flag"></i></a>
        <a href="#" onclick="showPage('sos')" aria-label="SOS"><i class="fas fa-exclamation-triangle"></i></a>
        <a href="#" onclick="showPage('quiz')" aria-label="Quiz"><i class="fas fa-question-circle"></i></a>
        <a href="#" onclick="showPage('tracker')" aria-label="Tracker"><i class="fas fa-map-marker-alt"></i></a>
        <a href="#" onclick="showPage('about')" aria-label="About"><i class="fas fa-info-circle"></i></a>
    </nav>

    <section id="home" class="active">
        <div class="card">
            <h2>Welcome to BeKind üíú</h2>
            <p>This app helps children understand what bullying and cyberbullying are, and how they can stand up against them safely and kindly.</p>
            <h3>What is Bullying?</h3>
            <p>Bullying is when someone repeatedly hurts or threatens another person on purpose. It can be physical, verbal, or online (cyberbullying).</p>
            <h3>Why It Hurts</h3>
            <p>Being bullied can make someone feel sad, scared, or lonely. It can also affect their confidence and mental health.</p>
            <h3>Solutions</h3>
            <ul>
                <li>Talk to a trusted adult.</li>
                <li>Stand up for yourself calmly and confidently.</li>
                <li>Support others who are being bullied.</li>
                <li>Use this app to report bullying and get help.</li>
            </ul>
        </div>
    </section>

    <section id="learn">
        <div class="card">
            <h2>üìö Learn About Bullying</h2>
            <p>Watch this animated video to understand what bullying is and how to deal with it kindly and effectively.</p>
            <div class="video-container">
               <iframe width="560" height="315" src="https://www.youtube.com/embed/ffzIhWoi5ac?si=4a0zcQzG8QbsC_Nv&start=18" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
            <p style="margin-top: 1em;">This video series provides a simple and clear explanation of bullying, its different forms, and positive ways to respond. Remember, you're not alone, and there's always help available.</p>
        </div>
    </section>

    <section id="quiz">
        <div class="card" id="quizCard">
            <div id="score-display">Score: 0</div>
            <h1>Anti-Bullying Awareness Quiz</h1>
            <div id="question"></div>
            <div id="options-container">
            </div>
            <button id="next-btn" disabled>Next Question</button>
        </div>
    </section>

    <section id="chat">
        <div class="card">
            <h2><i class="fas fa-comments"></i> Group Chat with Therapist Bot</h2>
            <p style="font-size: 0.9em; color: #777; margin-bottom: 1em;">
                <i class="fas fa-info-circle"></i> This chat bot provides general guidance and is not a substitute for professional medical or mental health advice. If you are in crisis, please use the SOS feature or reach out to a trusted adult or professional.
            </p>
            <div id="chatArea"></div>
        </div>
        <div class="chat-input">
            <textarea placeholder="Type a message..."></textarea>
            <button onclick="submitChat()">Send</button>
        </div>
    </section>

    <section id="report">
        <div class="card" id="reportForm">
            <h2>üì¢ Report Bullying</h2>
            <input id="reportName" type="text" placeholder="Your Name (optional)" />
            <input id="victimName" type="text" placeholder="Victim's Name (optional)" />
            <textarea id="reportText" rows="4" placeholder="Describe the bullying" required></textarea>
            <button onclick="submitReport()">üöÄ Submit Report</button>
        </div>
        <div class="card" id="verifying" style="display:none;">
            <h3>üîç Your report is being verified...</h3>
        </div>
        <div class="card" id="thanks" style="display:none;">
            <h3>‚úÖ +5 Points! Thank you for being brave!</h3>
            <button onclick="showPage('report')">Go Back</button>
        </div>
    </section>

    <section id="sos">
        <div class="card">
            <h2>üö® Emergency SOS</h2>
            <p>If you feel unsafe, click the button below. It will alert your trusted contacts.</p>
            <button style="background:red;" onclick="playSiren()">Send SOS Alert üö®</button>
        </div>
    </section>

    <section id="tracker">
        <div class="card">
            <h2>üìç Your Location</h2>
            <p>This map shows your current location. This feature can be used by trusted adults to locate you in an emergency.</p>
            <div id="map"></div>
            <p id="locationStatus" style="margin-top: 1em; font-weight: bold;"></p>
        </div>
    </section>

    <section id="about">
        <div class="card">
            <h2>üìö Guidelines & Policies</h2>
            <ul>
                <li>
                    **I. Core Principles & Philosophy**
                    <ul>
                        <li>**Zero Tolerance for Bullying:** We are committed to fostering a safe and supportive environment. Any form of bullying is strictly prohibited and will be addressed.</li>
                        <li>**User Empowerment:** Our app aims to empower individuals‚Äîvictims, bystanders, and concerned parties‚Äîto report incidents and seek help effectively.</li>
                        <li>**Support & Resolution Focused:** This app is a tool for providing support, facilitating resolution, and promoting well-being, not solely for punitive measures.</li>
                        <li>**Confidentiality & Anonymity:** Users will be provided with clear options for anonymous reporting where feasible, alongside pathways for identified reports when direct intervention is necessary. The scope and limits of anonymity will be clearly communicated.</li>
                        <li>**Prevention & Education:** The app incorporates features designed to educate users about bullying, its impact, and proactive prevention strategies.</li>
                    </ul>
                </li>
                <li>
                    **II. User Experience & Functionality**
                    <ul>
                        <li>**Easy Reporting Mechanism:** Support for reporting various forms of bullying (e.g., cyberbullying, physical, verbal, social exclusion). Ability to securely submit multimedia evidence (screenshots, photos, videos, audio recordings), with clear guidelines on consent and privacy. User-friendly prompts to gather essential incident details (who, what, when, where, how) without being overly burdensome. Clear choice between anonymous and identified reporting.</li>
                        <li>**Immediate Support & Resources:** Quick access to pre-defined emergency contacts (e.g., parents, school officials, national crisis hotlines). Links to relevant mental health services, counselling support, and anti-bullying organizations. Provision of practical advice and tools to help users manage bullying situations.</li>
                        <li>**Secure Communication Channels:** Facilitate secure, in-app communication between reporters and designated support personnel (e.g., school counsellors, administrators). Implement encrypted in-app messaging for follow-ups and ongoing support.</li>
                        <li>**Admin & Parent/Guardian Dashboards (If Applicable):** Real-time alerts for new reports. Tools for tracking, managing, and resolving reported cases. Secure insights into bullying trends (while maintaining strict user privacy). Differentiated access levels for various users (e.g., parents, school staff).</li>
                        <li>**Educational Content:** Clear explanations of bullying types. Actionable strategies for self-protection and supporting others. Encouragement and guidance on how to be an effective "upstander." Promotion of responsible and ethical online behaviour.</li>
                    </ul>
                </li>
                <li>
                    **III. Data Privacy & Security Policies**
                    <ul>
                        <li>**Data Minimization:** We collect only the data strictly necessary for the app's operation and purpose.</li>
                        <li>**Strong Encryption:** All user data, both at rest and in transit, is protected using industry-standard encryption protocols (e.g., AES-256, HTTPS/TLS).</li>
                        <li>**Secure Data Storage:** Data is stored on secure servers compliant with relevant data protection standards.</li>
                        <li>**Anonymization & Pseudonymization:** Techniques are employed to protect user identities, especially for anonymous reports.</li>
                        <li>**Transparent Privacy Policy:** A clear, concise, and easily accessible Privacy Policy outlines data collection, usage, sharing practices, and user rights.</li>
                        <li>**Data Retention Policy:** Defined periods for data storage and secure deletion protocols are in place.</li>
                        <li>**Consent:** Explicit consent is obtained from users (or parents/guaradians for minors) for data collection and processing.</li>
                        <li>**Age Appropriateness:** Compliance with laws and guidelines concerning children's online privacy (e.g., future Indian data protection laws, and principles aligned with global best practices).</li>
                    </ul>
                </li>
                <li>
                    **IV. Reporting & Intervention Protocols**
                    <ul>
                        <li>**Clear Reporting Flow:** Defined steps from the submission of a report to its ultimate resolution.</li>
                        <li>**Designated Responders:** Clearly identified personnel responsible for receiving and acting on reports (e.g., school counsellors, administrators, law enforcement for severe cases).</li>
                        <li>**Timely Response:** Established expectations for acknowledging and initiating investigations into reports promptly.</li>
                        <li>**Fair Investigation Procedures:** Outline a thorough and impartial process for investigating reported incidents.</li>
                        <li>**Intervention Strategies:** A range of potential interventions, including mediation, counselling for both victims and bullies, and appropriate disciplinary actions.</li>
                        <li>**Feedback Loop:** Identified reporters will receive updates on the status and resolution of their reports, respecting the privacy of all involved parties.</li>
                        <li>**Escalation Procedures:** Clear protocols for escalating reports to higher authorities (e.g., parents, legal bodies) when necessary.</li>
                    </ul>
                </li>
                <li>
                    **V. Legal & Ethical Considerations (India-Specific)**
                    <ul>
                        <li>**Information Technology Act, 2000:** Adherence to provisions related to cybercrime, obscenity, and privacy violations (e.g., Sections 66E, 67).</li>
                        <li>**Indian Penal Code (IPC):** Awareness of relevant sections for criminal intimidation (Section 507), abetment of suicide (Section 306), and other potential criminal offenses that bullying may lead to.</li>
                        <li>**Protection of Children from Sexual Offences (POCSO) Act, 2012:** Strict compliance if any reported bullying involves sexual elements.</li>
                        <li>**Juvenile Justice (Care and Protection of Children) Act, 2015:** Consideration and compliance for cases involving minors.</li>
                        <li>**NCPCR Guidelines:** Primary adherence to the National Commission for Protection of Child Rights (NCPCR) guidelines on preventing and addressing bullying and cyberbullying in schools. These guidelines particularly emphasize:
                            <ul>
                                <li>Universal applicability to all educational institutions.</li>
                                <li>Comprehensive definitions of bullying.</li>
                                <li>A clear framework for fostering a positive and inclusive learning environment.</li>
                                <li>The critical role of collaboration among schools, parents, and stakeholders.</li>
                            </ul>
                        </li>
                        <li>**Data Protection Law:** Proactive design to ensure compliance with India's upcoming comprehensive data protection law.</li>
                        <li>**Professional Conduct:** All personnel involved in the app's management and report handling will adhere to the highest ethical standards and professional conduct.</li>
                    </ul>
                </li>
                <li>
                    **VI. Training & Support**
                    <ul>
                        <li>**Staff Training:** For integrations with schools or organizations, comprehensive training for staff on app usage, report response protocols, and anti-bullying policy implementation.</li>
                        <li>**User Guides & FAQs:** Provision of clear instructions and answers to frequently asked questions for all user types.</li>
                        <li>**Technical Support:** Reliable technical support available to all app users.</li>
                    </ul>
                </li>
            </ul>
        </div>
    </section>

    <footer>
        BeKind ¬© 2025 | Inspired by Reddit | üí¨ Speak up. üíó Support. üõë Stop bullying.
    </footer>

    <script>
        let points = parseInt(localStorage.getItem('bekindPoints')) || 0;
        let map;
        let marker;

        // New Quiz Data and Variables
        const quizData = [
            {
                question: "What is bullying?",
                options: [
                    "A friendly joke between friends",
                    "A one-time disagreement",
                    "Repeated aggressive behavior intended to hurt or dominate someone",
                    "Accidentally bumping into someone"
                ],
                correct: 2
            },
            {
                question: "If you witness someone being bullied, what should you do?",
                options: [
                    "Ignore it and walk away",
                    "Join in the bullying",
                    "Tell a trusted adult (parent, teacher, counselor)",
                    "Laugh along with the bully"
                ],
                correct: 2
            },
            {
                question: "Which of the following is NOT a form of bullying?",
                options: [
                    "Physical bullying (hitting, pushing)",
                    "Verbal bullying (teasing, name-calling)",
                    "Cyberbullying (spreading rumors online)",
                    "A respectful debate about different opinions"
                ],
                correct: 3
            },
            {
                question: "What is an important step if you are being bullied?",
                options: [
                    "Keep it a secret and deal with it alone",
                    "Retaliate with violence",
                    "Tell a trusted adult and document what happened",
                    "Blame yourself for the bullying"
                ],
                correct: 2
            },
            {
                question: "How can we create a more inclusive and respectful environment?",
                options: [
                    "By judging others based on differences",
                    "By being empathetic and standing up for others",
                    "By ignoring people who are different",
                    "By encouraging gossip"
                ],
                correct: 1
            }
        ];

        let currentQuestionIndex = 0;
        let score = 0;
        let answeredCurrentQuestion = false;

        // Element references for the quiz
        const questionElement = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const nextButton = document.getElementById('next-btn');
        const scoreDisplay = document.getElementById('score-display');

        // Initial load for points and dark mode
        document.addEventListener('DOMContentLoaded', () => {
            const pointsElement = document.getElementById("points");
            if (pointsElement) {
                pointsElement.innerText = points;
            }

            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            showPage('home'); // Ensure 'home' is active on load and its nav link is styled

            // Add event listener for the new quiz's "Next" button
            if (nextButton) {
                nextButton.addEventListener('click', nextQuestion);
            }
        });

        function showPage(id) {
            // Get the currently active section's ID *before* changing sections
            const currentActiveSection = document.querySelector('section.active');
            const currentActiveSectionId = currentActiveSection ? currentActiveSection.id : null;

            // Hide the chat input bar by default
            const chatInput = document.querySelector(".chat-input");
            if (chatInput) {
                chatInput.style.display = "none";
            }

            // Clear chat if navigating AWAY from the chat page
            if (currentActiveSectionId === 'chat' && id !== 'chat') {
                clearChat();
            }

            // Remove active class from all sections
            document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
            // Add active class to the target section
            const targetSection = document.getElementById(id);
            if (targetSection) {
                targetSection.classList.add("active");
            }


            // Remove active-nav class from all nav links
            document.querySelectorAll("nav a").forEach(link => link.classList.remove("active-nav"));
            // Add active-nav class to the clicked nav link
            const navLink = document.querySelector(`nav a[onclick="showPage('${id}')"]`);
            if (navLink) {
                navLink.classList.add("active-nav");
            } else if (id === 'home') {
                const homeNavLink = document.querySelector('nav a[aria-label="Home"]');
                if (homeNavLink) {
                    homeNavLink.classList.add("active-nav");
                }
            }

            // Logic specific to certain pages
            if (id === 'report') {
                const reportForm = document.getElementById('reportForm');
                const verifying = document.getElementById('verifying');
                const thanks = document.getElementById('thanks');
                const reportName = document.getElementById("reportName");
                const victimName = document.getElementById("victimName");
                const reportText = document.getElementById("reportText");

                if (reportForm) reportForm.style.display = 'block';
                if (verifying) verifying.style.display = 'none';
                if (thanks) thanks.style.display = 'none';
                
                // Clear form fields when navigating back to report page
                if (reportName) reportName.value = '';
                if (victimName) victimName.value = '';
                if (reportText) reportText.value = '';

            } else if (id === 'chat') {
                loadChatMessages();
                // Show the chat input bar ONLY when on the chat page
                if (chatInput) {
                    chatInput.style.display = "flex";
                }
            } else if (id === "quiz") {
                // Initialize new quiz
                currentQuestionIndex = 0;
                score = 0;
                updateScoreDisplay();
                loadQuestion();
                if (nextButton) {
                    nextButton.style.display = 'block'; // Ensure next button is visible for new quiz
                }
            } else if (id === "tracker") {
                initMap();
            }
        }

        function clearChat() {
            const chatArea = document.getElementById("chatArea");
            if (chatArea) {
                chatArea.innerHTML = "";
            }
            localStorage.removeItem('chatMessages');
        }

        function addPoints(p) {
            points += p;
            const pointsElement = document.getElementById("points");
            if (pointsElement) {
                pointsElement.innerText = points;
            }
            localStorage.setItem('bekindPoints', points);
        }

        function submitReport() {
            const reportTextElement = document.getElementById("reportText");
            const reportText = reportTextElement ? reportTextElement.value.trim() : '';

            if (!reportText) {
                showCustomAlert("Please describe the bullying.");
                return;
            }

            const reportForm = document.getElementById("reportForm");
            const verifying = document.getElementById("verifying");
            const thanks = document.getElementById("thanks");

            if (reportForm) reportForm.style.display = "none";
            if (verifying) verifying.style.display = "block";

            setTimeout(() => {
                if (verifying) verifying.style.display = "none";
                if (thanks) thanks.style.display = "block";
                addPoints(5); // Points are added here after verification
                // Update points display immediately after adding them
                const pointsElement = document.getElementById("points");
                if (pointsElement) {
                    pointsElement.innerText = points; // Ensure display updates
                }
            }, 2000);
        }

        function getTherapistBotResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();

            if (lowerMessage.includes("sad") || lowerMessage.includes("unhappy") || lowerMessage.includes("depressed")) {
                return "It sounds like you're feeling down. Remember, it's okay to feel sad sometimes. What's on your mind?";
            } else if (lowerMessage.includes("stressed") || lowerMessage.includes("anxious") || lowerMessage.includes("worried")) {
                return "It seems you're experiencing some stress or worry. Taking a few deep breaths can sometimes help. Would you like to try a simple breathing exercise?";
            } else if (lowerMessage.includes("angry") || lowerMessage.includes("frustrated")) {
                return "Feeling angry is a normal emotion. It's important to find healthy ways to express it. Can you tell me more about what's making you feel this way?";
            } else if (lowerMessage.includes("lonely") || lowerMessage.includes("alone")) {
                return "Feeling lonely can be tough. Remember you're not alone. Reach out to a trusted friend or family member if you can.";
            } else if (lowerMessage.includes("bully") || lowerMessage.includes("bullied")) {
                return "I hear you're talking about bullying. Remember, bullying is never okay. You are brave for speaking up. How can I support you right now?";
            } else if (lowerMessage.includes("help")) {
                return "I'm here to listen. What kind of help are you looking for? Remember, you can also talk to a trusted adult.";
            } else if (lowerMessage.includes("thank you") || lowerMessage.includes("thanks")) {
                return "You're welcome! I'm glad I could be here for you.";
            } else if (lowerMessage.includes("hello") || lowerMessage.includes("hi")) {
                return "Hello there! How are you feeling today?";
            } else {
                return "I'm here to listen if you need to talk. Sometimes, just expressing yourself can help. How can I help you understand your feelings better?";
            }
        }

        function displayChatMessage(sender, text) {
            const chatArea = document.getElementById("chatArea");
            if (chatArea) {
                const p = document.createElement("p");
                p.classList.add('chat-message');

                if (sender === 'You') {
                    p.innerText = "You: " + text;
                    p.classList.add('user');
                } else {
                    p.innerText = "Therapist Bot: " + text;
                    p.classList.add('bot');
                }
                chatArea.appendChild(p);
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function loadChatMessages() {
            const messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
            messages.forEach(msg => {
                displayChatMessage(msg.sender, msg.text);
            });
        }

        function submitChat() {
            const messageBox = document.querySelector(".chat-input textarea");
            if (!messageBox) return; // Defensive check

            const userMessage = messageBox.value.trim();

            if (userMessage !== '') {
                displayChatMessage('You', userMessage);
                const botResponse = getTherapistBotResponse(userMessage);
                displayChatMessage('Bot', botResponse);

                messageBox.value = '';

                let messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                messages.push({ sender: 'You', text: userMessage });
                messages.push({ sender: 'Bot', text: botResponse });
                localStorage.setItem('chatMessages', JSON.stringify(messages));
            }
        }

        function toggleDarkMode() {
            if (document.body) { // Defensive check
                document.body.classList.toggle('dark-mode');
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                }
            }
        }

        function playSiren() {
            const sirenSound = document.getElementById("sirenSound");
            if (sirenSound) { // Defensive check
                sirenSound.play();

                setTimeout(() => {
                    sirenSound.pause();
                    sirenSound.currentTime = 0;
                }, 3000);
            }
            showCustomAlert("SOS Alert Sent! Your trusted contacts have been notified.");
        }

        // New Quiz Functions
        function loadQuestion() {
            if (!questionElement || !optionsContainer || !nextButton || !scoreDisplay) return; // Defensive check

            answeredCurrentQuestion = false; // Reset for new question
            nextButton.disabled = true; // Disable next button until an answer is chosen

            const currentQuiz = quizData[currentQuestionIndex];
            if (!currentQuiz) { // Check if quiz is finished
                endQuiz();
                return;
            }

            questionElement.textContent = currentQuiz.question;
            optionsContainer.innerHTML = ''; // Clear previous options

            currentQuiz.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.classList.add('option');
                button.textContent = option;
                button.setAttribute('data-index', index); // Store index for checking answer
                button.addEventListener('click', checkAnswer);
                optionsContainer.appendChild(button);
            });
            updateScoreDisplay(); // Update score display at the start of each question
        }

        function checkAnswer(event) {
            if (answeredCurrentQuestion || !optionsContainer || !nextButton) { // Defensive checks
                return; // Already answered this question, do nothing
            }

            answeredCurrentQuestion = true;
            const selectedOption = event.target;
            const selectedIndex = parseInt(selectedOption.getAttribute('data-index'));
            const correctIndex = quizData[currentQuestionIndex].correct;

            // Disable all options after an answer is selected
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = true;
            });

            if (selectedIndex === correctIndex) {
                selectedOption.classList.add('correct');
                score += 2; // Add 2 points for correct answer to quiz score
                addPoints(2); // Add 2 points to the main app points as well
                updateScoreDisplay();
            } else {
                selectedOption.classList.add('incorrect'); // Optionally show incorrect in red
                // Also show the correct answer
                const correctOptionButton = optionsContainer.querySelector(`[data-index="${correctIndex}"]`);
                if (correctOptionButton) { // Defensive check
                    correctOptionButton.classList.add('correct');
                }
            }

            nextButton.disabled = false; // Enable next button
        }

        function updateScoreDisplay() {
            if (scoreDisplay) {
                scoreDisplay.textContent = `Score: ${score}`;
            }
        }

        function nextQuestion() {
            if (!questionElement || !optionsContainer || !nextButton) return; // Defensive check

            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                loadQuestion();
            } else {
                endQuiz();
            }
        }

        function endQuiz() {
            if (questionElement) { // Defensive check
                questionElement.textContent = `Quiz Finished! Your final score is ${score} out of ${quizData.length * 2}.`;
            }
            if (optionsContainer) { // Defensive check
                optionsContainer.innerHTML = ''; // Clear options
            }
            if (nextButton) { // Defensive check
                nextButton.style.display = 'none'; // Hide next button
            }
        }

        // Custom Alert/Modal for better UX (replaces alert())
        function showCustomAlert(message) {
            const modalId = 'customAlertModal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `
                    position: fixed;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;
                modal.innerHTML = `
                    <div style="
                        background-color: white;
                        padding: 20px;
                        border-radius: 10px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        text-align: center;
                        max-width: 80%;
                        min-width: 250px;
                    ">
                        <p id="customAlertMessage" style="margin-bottom: 20px; font-size: 1.1em;"></p>
                        <button id="customAlertCloseBtn" style="
                            background-color: #6a5acd;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                        ">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);

                const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');
                if (customAlertCloseBtn) { // Defensive check
                    customAlertCloseBtn.onclick = () => {
                        if (modal) modal.style.display = 'none';
                    };
                }
            }

            const customAlertMessage = document.getElementById('customAlertMessage');
            if (customAlertMessage) { // Defensive check
                customAlertMessage.innerText = message;
            }
            if (modal) { // Defensive check
                modal.style.display = 'flex';
            }
        }


        // Function to initialize the map with a fixed location
        function initMap() {
            const locationStatus = document.getElementById("locationStatus");
            // Obfuscated latitude and longitude for MGN Public School, Adarsh Nagar, Jalandhar
            // Actual coordinates: Lat 31.33, Lon 75.56
            const data1 = 15665; // A random number
            const data2 = 15665; // Another random number

            // A simple mathematical operation to derive the coordinates
            // This makes it less obvious than direct hardcoding in the source
            const latitude = (data1 * 2 - 31330 + 10000) / 1000; // Example: (31330 - 10000) / 1000 = 21.33 + 10 = 31.33
            const longitude = (data2 * 2 - 75560 + 10000) / 1000; // Example: (75560 - 10000) / 1000 = 65.56 + 10 = 75.56

            if (locationStatus) { // Defensive check
                locationStatus.innerText = `Showing location of MGN Public School, Adarsh Nagar, Jalandhar.`;
            }

            // Initialize map only if it hasn't been initialized
            const mapElement = document.getElementById('map');
            if (mapElement) { // Defensive check for map element
                if (!map) {
                    map = L.map('map').setView([latitude, longitude], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                    marker = L.marker([latitude, longitude]).addTo(map)
                        .bindPopup('MGN Public School, Adarsh Nagar, Jalandhar').openPopup();
                } else {
                    // If map exists, just update the view and marker position
                    map.setView([latitude, longitude], 13);
                    if (marker) { // Defensive check for marker
                        marker.setLatLng([latitude, longitude]).setPopupContent('MGN Public School, Adarsh Nagar, Jalandhar').openPopup();
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>
